```{r}

pkgs <- c("targets", "magrittr")
pkgs_load <- sapply(pkgs, library, character.only = TRUE)
options(digits = 2, scipen = 999)

getGroup <- function(tbl, groupname) {
  sub_tbl <- tbl %>% subset(.$group == groupname, select = -group)
  return(sub_tbl)
}

results <- tar_read(ts_clust) %>%
  tibble::tibble() %>%
  dplyr::group_by(group) %>%
  dplyr::summarize(ce = mean(eigen), nc = mean(n_claim) %>% round() %>% scales::comma())

N06A <- results %>% getGroup("Antidepressants")
N05A <- results %>% getGroup("Antipsychotics")
N05B <- results %>% getGroup("Anxiolytics")
A0x  <- results %>% getGroup("Alimentary and metabolism")
B0x  <- results %>% getGroup("Blood")
C0x  <- results %>% getGroup("Cardiovascular")
N02  <- results %>% getGroup("Analgesics")
R0x  <- results %>% getGroup("Respiratory")

```

## Abstract

**Objectives:**
Mental health disorders are prevalent comorbidities affecting nearly two billion people worldwide. People with chronic diseases are at a higher risk of having mental health issues, which in turn potentially worsen their overall well-being. This investigation highlights the interrelatedness of mental health problems with other diagnoses, reflected as a relative importance score of psychopharmaca in a medication claim registry.

**Methods:**
Exploratory time-series analysis was performed using the University of Groningen prescription database, IADB.nl. Data from patients with at least one prescription of psychopharmaca from 2018 to 2022 was extracted. The prescription was evaluated daily using anatomical therapeutic chemical (ATC) classification, where psychopharmaca was evaluated at ATC level 3, drugs for the nervous system at ATC level 2, and other medications at ATC level 1, distinguished into a total of 24 medication classes. A medication-claim network was constructed as an undirected graph to capture dose-adjusted co-prescription. Eigenvector centrality ($c_e$) was computed as a measure of relative nodal importance, which reflects the degree of medication concurrence in a network. The number of medication claims ($n_c$), number of patients, claim-to-patient ratio, and eigenvector centrality were extracted as weekly-aggregated time-series data. Singular spectrum analysis was performed to decompose the data into its constituting trend, periodicity, and white noises.

**Results:**
Antidepressants (ATC `N06A`, $c_e$ = `r N06A$ce`, $n_c$ = `r N06A$nc`), antipsychotics (`N05A`, $c_e$ = `r N05A$ce`, $n_c$ = `r N05A$nc`), and anxiolytics (`N05B`, $c_e$ = `r N05B$ce`, $n_c$ = `r N05B$nc`) are psychopharmaca with high eigenvector centrality. These classes of medication are likely to be co-prescribed alongside other medications. Further groups with high eigenvector centrality were medications for alimentary and metabolism (`A01-A16`, $c_e$ = `r A0x$ce`, $n_c$ = `r A0x$nc`), blood (`B01-B06`, $c_e$ = `r B0x$ce`, $n_c$ = `r B0x$nc`), cardiovascular (`C01-C10`, $c_e$ = `r C0x$ce`, $n_c$ = `r C0x$ne`), analgesics (`N02`, $c_e$ = `r N02$ce`, $n_c$ `r N02$nc`), and respiratory (`R01-R07`, $c_e$ = `r R0x$ce`, $n_c$ = `r R0x$nc`). High eigenvector centrality implies that these medications are likely to be co-prescribed with other medications. Only antidepressants had a positive time trend for both eigenvector centrality and actual number of claims.

**Discussion:**
Eight medications, three of which are psychopharmaca, have a high eigenvector centrality, implying its concurrence on a population level. Positive time trends in both eigenvector centrality and claims suggest that increasing uses of antidepressants are related to co-prescription with other medication classes. Constructing a medication claim network enriches the exploratory analysis of medication use at the population level.

{{< pagebreak >}}

## Analytical procedures

### Source of data

The University of Groningen IADB.nl pharmacy prescription database is a growing database that contains prescription data for 31 years from 1994 till 2024 from approximately 120 community pharmacies and covers an estimated population of 1,120,000 patients. Registration in the database is irrespective of health care insurance and age, gender and prescription rates among the database population have been found to be representative of the Netherlands as a whole, and the database has been widely used for research. Each person is individually tracked throughout the database period and prescription records contain information on the date of dispensing, the quantity dispensed, the dose regimen, the number of days the prescription is valid, the prescribing physician and the Anatomical Therapeutic Chemical code (ATC code). Each patient has a unique anonymous identifier; date of birth and gender are known. Due to the high patient-pharmacy commitment in the Netherlands, the medication records for each patient are virtually complete, except for over the counter (OTC) drugs and medication dispensed during hospitalization. This analysis include daily medication claims from a static cohort of adults aged 18-65 years old and prescribed for anxiolytics or antidepressants at least once in the time span from 2018 to 2022.

### Data pre-processing

Daily medication claims is a tabular data containing values from single medication entity for each patients in the cohort. Data transformation was performed to construct a square matrix of aggregate medication claim per day, with rows and columns representing groups of medication. Each element in the upper and lower triangle represents co-prescriptions, while the diagonal of the matrix represents single prescriptions. All elements in the matrix is a tally of drug combination/single prescription in a population level claimed on a daily basis. The matrix follows a knowledge graph construct with a subject-predicate-object (s, p, o) triples, i.e. `Medication1-PrescribedAlongside-Medication2`. The knowledge graph is a representation of medication-claim network, where the edge (predicate) is the number of concurrency. Weight was applied on the edges by dividing it by the defined daily dose (DDD). Weighting is necessary to regularize the matrix into a unit-free scale, which allow a direct comparison of one drug to another.

$$
\stackrel{\textrm{Unregularized}}{
  \begin{bmatrix}
  n_{1, 1} & \dots & n_{1, N} \\
  \vdots & \ddots & \vdots \\
  n_{N, 1} & \dots & n_{N, N} \\
  \end{bmatrix}
}
\to
\stackrel{\textrm{Regularized by } DDD}{
  \begin{bmatrix}
  \frac{1}{2} \cdot \left(\frac{n_1}{DDD_1} + \frac{n_1}{DDD_1} \right) & \dots & \frac{1}{2} \cdot \left(\frac{n_1}{DDD_1} + \frac{n_N}{DDD_N} \right) \\
  \vdots & \ddots & \vdots \\
  \frac{1}{2} \cdot \left(\frac{n_N}{DDD_N} + \frac{n_1}{DDD_1} \right) & \dots & \frac{1}{2} \cdot \left(\frac{n_N}{DDD_N} + \frac{n_N}{DDD_N} \right) \\
  \end{bmatrix}
}
$$ {#eq-regularize-mtx}

### Measuring relative importance

As all medications are nodes in a claim network, we can measure the property of each medication using graph theory. One way to represent node property is by calculating node centrality, which can be measured as a number of incoming/outgoing edges (degree) or its connectedness to other nodes (importance). We measured importance using eigenvector centrality, which reflects medication co-occurrence with other important medications. Eigenvector centrality is a recursive measures of how well connected a certain node is to other nodes that is also well connected in the network [@Golbeck2013]. @eq-eigen-centrality outlines the calculation of eigenvector centrality; $\c_i$ and $\c_j$ are the centralities of node $i$ and $j$, respectively; $\lambda$ is the eigenvalue; $a_{j, i}$ is an element on row $j$ and column $i$ from an adjacency matrix $A$, representing the connection between node $a_i$ and $a_j$.

$$
\displaystyle c_i = \frac{1}{\lambda} \sum_{j \neq i} a_{j, i} \cdot c_j
$$ {#eq-eigen-centrality}

{{< include exec-summary/descriptive.qmd >}}

{{< include exec-summary/seasonality.qmd >}}

{{< include exec-summary/arima.qmd >}}

{{< include exec-summary/spectral.qmd >}}

## Highlighted findings

- @tbl-mean-diff describes difference in several measures before and during the COVID-19 pandemic
  - Further analysis is necessary and will be planned for later investigation
  - Interrupted time-series analysis should be conducted by considering:
    1. Counterfactual data using trend before COVID-19
    1. Counterfactual data using trend during COVID-19 given policy changes
    1. Calculate the mean percentage changes between counterfactual and actual data
- @sec-decom-classic-stl displays the data after classical and STL seasonal decomposition
  - The data still presents with other patterns, implying that seasonality does not completely explains the variance
  - Eigenvector centrality on daily, weekly, and monthly series suggests high importance of several psychopharmaca, including:
    1. Antidepressants
    1. Antipsychotics
    1. Anxiolytics
    1. Hypnotic and sedatives
  - Other medications considered important by eigenvector centrality:
    1. Alimentary and metabolism
    1. Cardiovascular
    1. Analgesics
    1. Respiratory
  - High eigenvector centrality implies that these eight medications are often co-prescribed
- @sec-seasonality demonstrates two repeating patterns in medication claims:
  - Increasing claims on Monday and decreasing claims on Saturday in the daily data, implying day-to-day differences
  - Increasing claims in March and December in the monthly data, this pattern is persistent for weekly data as well
  - Weekly data better captures repeating patterns and should be use for further analysis
- Model evaluation tables in @sec-arima consistently show high value of intercept
  - All models for medication claims have a relatively low effect size for AR, MA, or drift term
  - No model has fitted with a (P, D, Q) term, implying no detected seasonality for models maximizing AICc
  - Seasonality might be undetected due to the presence of noise and other underlying periodicity
- @tbl-trend shows differences between the actual and decomposed data
  - Trend is more visible in the decomposed data due to being free from noises and periodicity
  - The magnitude of detected trend is naturally larger, and still implies the same monotonicity with the original data
  - The number of claims in 11 medication classes are declining overtime
  - The relative importance in 14 medication classes are declining overtime
  - Changes in claim represents the actual change of the expected number of medication claim in the population. Changes in importance represents changes of how likely a medication being prescribed together. Differences between relative importance and number of medication claims are observed in:
    1. Genitourinary: decreasing claim, increasing importance
    1. Systemic hormonal: increasing claim, decreasing importance
    1. Antiparkinson: increasing claim, decreasing importance
    1. Antipsychotics: increasing claim, decreasing importance
    1. Antidementia: increasing claim, decreasing importance
    1. Other nervous system drugs: decreasing claim, increasing importance
    1. Antiparasitics: increasing claim, decreasing importance
- @tbl-resid-n-claim and @tbl-resid-eigen shows the residuals analysis of the decomposition model using singular spectrum analysis
  - All residuals are stationary, i.e. having a constant mean and variance
  - All residuals follow the normal distribution (see especially Shapiro-Wilk statistics, mean, and standard deviation)
  - These findings imply that the residuals of decomposition models are likely to be evenly and randomly distributed
- @sec-recon depicts complex periodicity within each time series
  - These go in line with findings from @sec-seasonality
  - Despite visible patterns of weekly and yearly seasonality, these patterns are obscured with other oscillating functions
  - The oscillating functions were ordered based on their contribution in explaining the variance in the data, e.g. `F1` has a higher contribution than `F2`, and so on


::: {.content-visible when-profile="summary"}

\uselandscape

## Excerpt on findings

### Pair plot

```{r}

tar_read(plt_pair)[[17]]

```

### Dot plots on weekly time-series

```{r}

tar_read(plt_dot_week)[[1]]

```

### Differenced time-series on a weekly interval

```{r}

tar_read(plt_dot_diff_week)[[1]]

```

### Exploring seasonality within the number of medication claims

```{r}

tar_read(plt_period_month)[[1]]
tar_read(plt_acf_diff_month)[[1]]
tar_read(plt_pacf_diff_month)[[1]]

```

### Exploring ARIMA model

```{r}

tar_read(plt_arima_forecast_n_claim)[[17]]

```

### Decomposed time-series with SSA

```{r}

tar_read(plt_ssa_recon_n_claim)[[17]]

```

\normalpapersize

:::
